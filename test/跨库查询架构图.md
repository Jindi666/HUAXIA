# 跨库查询架构可视化说明

## 架构层次图

```
┌──────────────────────────────────────────────────────────────────────┐
│                        .NET WebApi 后端服务                            │
│                   (端口: 5000 | 进程: Laiye.Customer.WebApi)           │
└─────────────────────────────────────┬────────────────────────────────┘
                                      │
                                      │ 1. 通过 FreeSql 建立 MySQL 连接
                                      │ 2. 连接字符串配置
                                      ▼
                   ┌────────────────────────────────────────────────┐
                   │          MySQL 连接配置                        │
                   │  Server: localhost:3306                        │
                   │  User: root                                    │
                   │  Password: ********                            │
                   │  Database: huaxia (默认数据库)                  │
                   └────────────────────────────────────────────────┘
                                      │
                                      │ TCP 连接
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     MySQL 服务器实例 (localhost:3306)                   │
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    数据库: huaxia (默认)                         │  │
│  ├─────────────────────────────────────────────────────────────────┤  │
│  │  表:                                                             │  │
│  │  • t_dashboard_result_topinfo           (成果展示统计)            │  │
│  │  • t_dashboard_result_TaskSuccRate_Department                   │  │
│  │  • t_dashboard_monitor_topinfo          (监控数据)                │  │
│  │  • t_dashboard_monitor_realtime_info                            │  │
│  │  • t_dashboard_task_failed_today                                │  │
│  │  • user_login                        (用户登录)                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                    ▲                                   │
│                                    │ 默认查询                           │
│                                    │ SELECT * FROM table_name           │
│                                    │ (不需要指定数据库名)                │
│                                    │                                   │
│  ┌─────────────────────────────────┴─────────────────────────────────┐ │
│  │                    数据库: uibot_rpa (跨库)                       │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │  表:                                                             │  │
│  │  • tbl_user_worker                   (人机交互机器人)              │ │
│  │  • tbl_worker                        (无人值守机器人)              │  │
│  │  • tbl_flow                          (流程信息)                    │  │
│  │  • tbl_task                          (任务信息)                    │  │
│  └─────────────────────────────────────────────────────────────────┘ │
│                              ▲                                         │
│                              │ 跨库查询                                │
│                              │ SELECT * FROM uibot_rpa.table_name      │
│                              │ (必须指定数据库名)                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## SQL 查询对比示例

### 场景 1：查询默认数据库 (huaxia)

**代码位置**: `HuaxiajijinEverydayController.cs:73`

```csharp
// C# 代码
StringBuilder sb1 = new StringBuilder();
sb1.append(" select * from t_dashboard_monitor_topinfo where update_date=date_format(NOW(),'%Y-%m-%d') ");
var sql1 = sb1.toString();
var query = conn.Select<EverydayTopBean>().WithSql(@sql1).ToOne();
```

**实际执行的 SQL**:
```sql
-- 不需要指定数据库名，因为连接的默认数据库就是 huaxia
SELECT * FROM t_dashboard_monitor_topinfo
WHERE update_date = DATE_FORMAT(NOW(),'%Y-%m-%d');

-- 等价于
SELECT * FROM huaxia.t_dashboard_monitor_topinfo
WHERE update_date = DATE_FORMAT(NOW(),'%Y-%m-%d');
```

---

### 场景 2：跨库查询 (uibot_rpa)

**代码位置**: `HuaxiajijinController.cs:342`

```csharp
// C# 代码
StringBuilder sb1 = new StringBuilder();
sb1.append(" select count(*) as manMachineOnline from uibot_rpa.tbl_user_worker where worker_state=2 ");
var sql1 = sb1.toString();
var manMachineBean = conn.Select<ManOnlineBean>().WithSql(@sql1).ToOne();
```

**实际执行的 SQL**:
```sql
-- 必须指定数据库名 uibot_rpa
SELECT count(*) as manMachineOnline
FROM uibot_rpa.tbl_user_worker
WHERE worker_state = 2;
```

---

## 连接字符串详解

### 当前配置文件

**文件**: `Configs/appsettings.json`

```json
{
  "Db": {
    "Connection": "Server=localhost;Port=3306;Database=huaxia;User Id=root;Password=zj20031234000;Charset=utf8mb4;AllowUserVariables=True;Connection Timeout=60;Default Command Timeout=60;SslMode=None;Persist Security Info=False;UseAffectedRows=False;Pooling=True;Min Pool Size=0;Max Pool Size=100;Connection Lifetime=0;"
  }
}
```

### 参数分解

```
参数名                   值                          说明
─────────────────────────────────────────────────────────────────────
Server                localhost                  MySQL 服务器地址
Port                  3306                       MySQL 端口
Database              huaxia                     ✨ 默认数据库（连接后自动 USE）
User Id               root                       数据库用户名
Password              zj20031234000              数据库密码
Charset               utf8mb4                    字符集（支持 emoji）
AllowUserVariables    True                       允许使用 @变量
Connection Timeout    60                         连接超时（秒）
Default Command Timeout 60                       命令执行超时（秒）
Pooling               True                       启用连接池
Min Pool Size         0                          连接池最小连接数
Max Pool Size         100                        连接池最大连接数
```

---

## 跨库查询的关键要点

### ✅ 可以跨库查询的条件

1. **同一个 MySQL 服务器实例**
   ```
   ✅ Server: localhost (相同)
   ✅ Port: 3306 (相同)
   ```

2. **用户有权限访问多个数据库**
   ```sql
   -- root 用户通常有所有数据库的权限
   GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost';
   ```

3. **使用正确的语法**
   ```sql
   -- 格式：数据库名.表名
   SELECT * FROM uibot_rpa.tbl_user_worker;
   ```

### ❌ 不能跨库查询的情况

1. **不同的 MySQL 服务器**
   ```
   ❌ localhost:3306/huaxia
   ❌ 192.168.1.100:3306/uibot_rpa  (不同的服务器)
   ```
   → 需要创建多个数据库连接

2. **用户没有目标数据库的权限**
   ```sql
   -- 如果用户只有 huaxia 的权限
   GRANT SELECT ON huaxia.* TO 'appuser'@'localhost';
   -- 则无法查询 uibot_rpa
   ```

---

## 数据流向示意图

```
┌─────────────────────────────────────────────────────────────────┐
│                          前端大屏                                │
│                      (Vue/React 应用)                            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              │ HTTP POST 请求
                              │ /huaxia/screen/dashboard/workerOnline
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     HuaxiajijinController                        │
│                          workerOnline()                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              │ FreeSql 查询
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        IFreeSql (ORM)                            │
│              (已配置连接到 huaxia 数据库)                         │
└──────┬──────────────────────────────────────────────────┬───────┘
       │                                                  │
       │ 查询 1-3: huaxia 数据表                          │ 查询 4: 跨库
       ▼                                                  ▼
┌──────────────────────┐                    ┌──────────────────────────┐
│  huaxia 数据库       │                    │  uibot_rpa 数据库        │
│  (默认连接)          │                    │  (跨库访问)              │
├──────────────────────┤                    ├──────────────────────────┤
│ • t_dashboard_      │                    │ • tbl_user_worker        │
│   result_*          │                    │ • tbl_worker             │
│ • t_dashboard_      │                    │ • tbl_flow               │
│   monitor_*         │                    │ • tbl_task               │
│ • user_login        │                    │                          │
└──────────────────────┘                    └──────────────────────────┘
       │                                                  │
       │ 返回: 汇总统计数据                               │ 返回: 实时业务数据
       │                                                  │
       └──────────────────────┬───────────────────────────┘
                              ▼
                    ┌─────────────────────┐
                    │  组装返回结果        │
                    │  WorkerBean         │
                    │  - manMachineOnline │
                    │  - unmannedOnline   │
                    │  ...                │
                    └─────────────────────┘
                              │
                              │ JSON 响应
                              ▼
                    ┌─────────────────────┐
                    │  前端大屏展示        │
                    └─────────────────────┘
```

---

## 实际代码示例

### 示例 1：默认库查询（不需要数据库名前缀）

```csharp
// 文件: HuaxiajijinEverydayController.cs:255
sb1.append(" select flowCount, totalTask from t_dashboard_result_topinfo ");
```

**SQL**:
```sql
SELECT flowCount, totalTask
FROM t_dashboard_result_topinfo
WHERE update_date = DATE_FORMAT(NOW(),'%Y-%m-%d');
-- 实际执行: FROM huaxia.t_dashboard_result_topinfo
```

---

### 示例 2：跨库查询（需要数据库名前缀）

```csharp
// 文件: HuaxiajijinController.cs:342
sb1.append(" select count(*) as manMachineOnline from uibot_rpa.tbl_user_worker where worker_state=2 ");
```

**SQL**:
```sql
SELECT count(*) as manMachineOnline
FROM uibot_rpa.tbl_user_worker   -- ✅ 必须指定 uibot_rpa
WHERE worker_state = 2;
```

---

## 权限配置命令

### 查看 root 用户权限

```bash
mysql -uroot -pzj20031234000 -e "SHOW GRANTS FOR 'root'@'localhost';"
```

**预期输出**:
```
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION
--                         ^^
--                         表示所有数据库的权限
```

### 验证跨库查询权限

```bash
# 测试访问 huaxia 数据库
mysql -uroot -pzj20031234000 -e "USE huaxia; SELECT COUNT(*) FROM user_login;"

# 测试访问 uibot_rpa 数据库（如果存在）
mysql -uroot -pzj20031234000 -e "USE huaxia; SELECT COUNT(*) FROM uibot_rpa.tbl_user_worker;"
```

---

## 常见问题排查

### 问题 1: Table 'uibot_rpa.tbl_user_worker' doesn't exist

**原因**:
- uibot_rpa 数据库不存在
- 或者表不存在

**检查**:
```sql
-- 检查数据库是否存在
SHOW DATABASES LIKE 'uibot_rpa';

-- 检查表是否存在
USE uibot_rpa;
SHOW TABLES LIKE 'tbl_user_worker';
```

---

### 问题 2: Access denied for user 'root'@'localhost'

**原因**:
- root 用户没有 uibot_rpa 数据库的权限

**解决**:
```sql
GRANT ALL PRIVILEGES ON uibot_rpa.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

---

## 总结

### 关键概念

| 概念 | 说明 | 示例 |
|------|------|------|
| **默认数据库** | 连接字符串中指定的数据库 | `Database=huaxia` |
| **跨库查询** | 在同一 MySQL 服务器中查询其他数据库 | `SELECT * FROM uibot_rpa.table` |
| **权限要求** | 用户需要访问目标数据库的权限 | `GRANT SELECT ON uibot_rpa.*` |
| **语法格式** | 数据库名.表名 | `uibot_rpa.tbl_user_worker` |

### 项目中的应用

- **主数据库 (huaxia)**: 90% 的查询
  - 预处理的统计数据
  - 大屏展示的汇总信息

- **跨库查询 (uibot_rpa)**: 10% 的查询
  - 实时业务数据
  - 机器人在线状态等动态信息

### 架构优势

```
┌────────────────────────────────────────────────────┐
│           数据仓库层 (huaxia)                        │
│     快速查询、预聚合、适合大屏展示                   │
└────────────────────────────────────────────────────┘
                       ↑ 数据同步
                       │ ETL 定时任务
┌────────────────────────────────────────────────────┐
│         业务系统层 (uibot_rpa)                      │
│      原始数据、实时更新、RPA 业务操作               │
└────────────────────────────────────────────────────┘
```

这种架构实现了：
- ✅ 性能优化（预聚合数据）
- ✅ 系统解耦（不影响 RPA 业务）
- ✅ 灵活查询（可根据需求选择数据源）

# MySQL 跨库查询详细说明

## 一、当前项目的数据库配置

### 1.1 配置文件位置

文件路径：`Laiye.Customer.WebApi\Configs\appsettings.json`

```json
{
  "Db": {
    "Connection": "Server=localhost;Port=3306;Database=huaxia;User Id=root;Password=zj20031234000;Charset=utf8mb4;AllowUserVariables=True;Connection Timeout=60;Default Command Timeout=60;SslMode=None;Persist Security Info=False;UseAffectedRows=False;Pooling=True;Min Pool Size=0;Max Pool Size=100;Connection Lifetime=0;"
  }
}
```

### 1.2 连接参数解析

| 参数 | 值 | 说明 |
|------|-----|------|
| Server | localhost | MySQL 服务器地址 |
| Port | 3306 | MySQL 端口 |
| Database | huaxia | **默认数据库**（连接后默认使用） |
| User Id | root | 数据库用户 |
| Password | zj20031234000 | 数据库密码 |
| CharSet | utf8mb4 | 字符集 |
| AllowUserVariables | True | 允许使用用户变量（如 @变量名） |

---

## 二、MySQL 跨库查询原理

### 2.1 什么是跨库查询？

跨库查询是指在同一个 MySQL 服务器实例中，从一个数据库查询另一个数据库的表。

**语法格式**：
```sql
SELECT * FROM 数据库名.表名 WHERE 条件;
```

**示例**：
```sql
-- 从 uibot_rpa 数据库查询 tbl_user_worker 表
SELECT * FROM uibot_rpa.tbl_user_worker WHERE worker_state = 2;

-- 从 huaxia 数据库查询 t_dashboard_result_topinfo 表
SELECT * FROM huaxia.t_dashboard_result_topinfo WHERE update_date = '2026-02-04';
```

### 2.2 为什么可以跨库查询？

MySQL 的跨库查询基于以下机制：

1. **同一 MySQL 实例**：所有数据库都在同一个 MySQL 服务器实例中
2. **用户权限**：MySQL 用户只要有权限访问多个数据库，就可以跨库查询
3. **命名空间隔离**：使用 `数据库名.表名` 的格式来区分不同数据库的表

**图示**：
```
MySQL 服务器实例 (localhost:3306)
│
├── 数据库: huaxia (默认连接)
│   ├── t_dashboard_result_topinfo
│   ├── t_dashboard_monitor_*
│   └── user_login
│
└── 数据库: uibot_rpa (通过跨库访问)
    ├── tbl_user_worker
    └── tbl_worker
```

---

## 三、项目中的跨库查询实例

### 3.1 实际代码位置

文件：`Laiye.Customer.WebApi\Controllers\HuaxiajijinController.cs`
方法：`workerOnline` (第 335-379 行)

### 3.2 跨库查询代码分析

```csharp
[HttpPost("workerOnline")]
public BaseResponse<WorkerBean> WorkerOnline([FromServices] IFreeSql conn)
{
    try
    {
        // ✅ 跨库查询 1：从 uibot_rpa 数据库查询人机交互机器人在线数量
        StringBuilder sb1 = new StringBuilder();
        sb1.append(" select count(*) as manMachineOnline  from uibot_rpa.tbl_user_worker where worker_state=2  ");
        var sql1 = sb1.toString();
        var manMachineBean = conn.Select<ManOnlineBean>().WithSql(@sql1).ToOne();

        // ✅ 跨库查询 2：从 uibot_rpa 数据库查询人机交互机器人离线数量
        StringBuilder sb2 = new StringBuilder();
        sb2.append(" select count(*) as manMachineNotOnline  from uibot_rpa.tbl_user_worker where worker_state=3  ");
        var sql2 = sb2.toString();
        var manNotOnlineBean = conn.Select<ManNotOnlineBean>().WithSql(@sql2).ToOne();

        // ✅ 跨库查询 3：从 uibot_rpa 数据库查询无人值守机器人在线数量
        StringBuilder sb3 = new StringBuilder();
        sb3.append(" select count(*) as unmannedOnline  from uibot_rpa.tbl_worker where worker_type=2 and worker_state=2 ");
        var sql3 = sb3.toString();
        var unManOnlineBean = conn.Select<UnManOnlineBean>().WithSql(@sql3).ToOne();

        // ✅ 跨库查询 4：从 uibot_rpa 数据库查询无人值守机器人离线数量
        StringBuilder sb4 = new StringBuilder();
        sb4.append(" select count(*) as unmannedNotOnline from uibot_rpa.tbl_worker where worker_type=2 and worker_state=3 ");
        var sql4 = sb4.toString();
        var unManNotOnlineBean = conn.Select<UnManNotOnlineBean>().WithSql(@sql4).ToOne();

        // 组装返回结果
        var workerBean = new WorkerBean
        {
            manMachineOnline = manMachineBean.manMachineOnline,
            manMachineNotOnline = manNotOnlineBean.manMachineNotOnline,
            unmannedOnline = unManOnlineBean.unmannedOnline,
            unmannedNotOnline = unManNotOnlineBean.unmannedNotOnline,
        };
        return new BaseResponse<WorkerBean>(workerBean);
    }
    catch (Exception ex)
    {
        Logger.LogWarning(ex, ex.Message);
    }
    return new BaseResponse<WorkerBean>();
}
```

### 3.3 SQL 执行分析

当 FreeSql 执行上述 SQL 时，实际发送给 MySQL 的命令是：

```sql
-- 连接到 huaxia 数据库（默认）
USE huaxia;

-- 跨库查询 uibot_rpa 数据库
SELECT count(*) as manMachineOnline FROM uibot_rpa.tbl_user_worker WHERE worker_state=2;
SELECT count(*) as manMachineNotOnline FROM uibot_rpa.tbl_user_worker WHERE worker_state=3;
SELECT count(*) as unmannedOnline FROM uibot_rpa.tbl_worker WHERE worker_type=2 AND worker_state=2;
SELECT count(*) as unmannedNotOnline FROM uibot_rpa.tbl_worker WHERE worker_type=2 AND worker_state=3;
```

---

## 四、跨库查询的权限要求

### 4.1 MySQL 用户权限配置

为了让 root 用户能够跨库查询，需要授予以下权限：

```sql
-- 授予用户访问多个数据库的权限
GRANT SELECT ON huaxia.* TO 'root'@'localhost';
GRANT SELECT ON uibot_rpa.* TO 'root'@'localhost';

-- 或者授予所有权限
GRANT ALL PRIVILEGES ON huaxia.* TO 'root'@'localhost';
GRANT ALL PRIVILEGES ON uibot_rpa.* TO 'root'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 4.2 权限验证命令

```bash
# 查看当前用户的权限
mysql -uroot -p -e "SHOW GRANTS FOR CURRENT_USER();"

# 查看特定数据库的访问权限
mysql -uroot -p -e "SHOW GRANTS FOR 'root'@'localhost';"
```

---

## 五、项目中的数据库使用模式

### 5.1 数据访问模式对比

| 查询类型 | SQL 示例 | 使用场景 | 代码位置 |
|----------|----------|----------|----------|
| **默认库查询** | `SELECT * FROM t_dashboard_result_topinfo` | 查询汇总统计数据 | 大部分接口 |
| **跨库查询** | `SELECT * FROM uibot_rpa.tbl_user_worker` | 查询 RPA 实时数据 | `workerOnline` 接口 |

### 5.2 为什么使用跨库查询？

**原因分析**：

1. **数据分离**：
   - `huaxia`：存储预处理的大屏展示数据（数据仓库）
   - `uibot_rpa`：存储 RPA 平台原始业务数据（业务系统）

2. **性能考虑**：
   - 大部分数据从 `huaxia` 查询（预聚合，查询快速）
   - 少量实时数据从 `uibot_rpa` 查询（如机器人实时状态）

3. **架构优势**：
   - 解耦：大屏数据不影响 RPA 业务系统
   - 灵活：可以选择数据来源（汇总数据 vs 原始数据）

---

## 六、当前项目的实际数据库情况

### 6.1 当前 MySQL 实例中的数据库

根据连接测试，当前 MySQL 服务器中存在以下数据库：

```
✅ huaxia (主数据库，已配置)
❌ uibot_rpa (跨库查询的目标数据库 - 当前不存在)

其他数据库：
- book_25_09, book_25_10
- caoniao
- information_schema, mysql, performance_schema, sys
- reggie, reggie_take_out
- sakila
- sky_take_out, store, student
- world, xinshou, xinshou2
```

### 6.2 重要发现

**当前环境问题**：
- ❌ `uibot_rpa` 数据库在当前 MySQL 实例中**不存在**
- ⚠️ 这意味着跨库查询的代码在当前环境下会**执行失败**

**预期环境**：
- 生产环境中应该存在 `uibot_rpa` 数据库
- 该数据库包含 RPA 平台的核心业务表

---

## 七、跨库查询的完整配置示例

### 7.1 连接字符串配置（当前配置）

```json
{
  "Db": {
    "Connection": "Server=localhost;Port=3306;Database=huaxia;User Id=root;Password=zj20031234000;..."
  }
}
```

**说明**：
- `Database=huaxia`：指定默认数据库
- 但可以访问同一服务器上的其他数据库（如 `uibot_rpa`）

### 7.2 如果需要多个数据库连接

如果需要连接到**不同的 MySQL 服务器**，则需要配置多个连接：

```json
{
  "Db": {
    "HuaxiaConnection": "Server=localhost;Port=3306;Database=huaxia;User Id=root;Password=xxx;",
    "RpaConnection": "Server=192.168.1.100;Port=3306;Database=uibot_rpa;User Id=root;Password=xxx;"
  }
}
```

然后在代码中创建多个 FreeSql 实例：
```csharp
services.AddSingleton<IFreeSql>("huaxia", new FreeSqlBuilder()
    .UseConnectionString(DataType.MySql, configuration["Db:HuaxiaConnection"])
    .Build());

services.AddSingleton<IFreeSql>("rpa", new FreeSqlBuilder()
    .UseConnectionString(DataType.MySql, configuration["Db:RpaConnection"])
    .Build());
```

---

## 八、测试跨库查询

### 8.1 验证跨库查询是否可用

```bash
# 连接到 MySQL
mysql -uroot -pzj20031234000 -h localhost

# 测试跨库查询（如果 uibot_rpa 存在）
USE huaxia;
SELECT COUNT(*) FROM uibot_rpa.tbl_user_worker;
```

### 8.2 模拟跨库查询环境

如果需要测试，可以创建模拟表：

```sql
-- 在 huaxia 数据库中创建测试表
USE huaxia;
CREATE TABLE IF NOT EXISTS tbl_user_worker (
    worker_id INT,
    worker_state INT,
    worker_name VARCHAR(100)
);

-- 测试跨库查询语法（虽然实际在同一个数据库）
SELECT COUNT(*) FROM huaxia.tbl_user_worker WHERE worker_state = 2;
```

---

## 九、总结

### 9.1 关键要点

1. **跨库查询条件**：
   - ✅ 同一 MySQL 服务器实例
   - ✅ 用户有权限访问多个数据库
   - ✅ 使用 `数据库名.表名` 格式

2. **当前项目配置**：
   - 连接到 `huaxia` 数据库
   - 通过 `uibot_rpa.tbl_user_worker` 跨库查询
   - ⚠️ 当前环境缺少 `uibot_rpa` 数据库

3. **架构设计**：
   - `huaxia`：数据仓库（预处理数据）
   - `uibot_rpa`：业务系统（原始数据）
   - 灵活选择数据源

### 9.2 权限配置检查清单

- [ ] root 用户有 huaxia 数据库的 SELECT 权限
- [ ] root 用户有 uibot_rpa 数据库的 SELECT 权限
- [ ] uibot_rpa 数据库存在
- [ ] uibot_rpa.tbl_user_worker 表存在
- [ ] uibot_rpa.tbl_worker 表存在

---

## 十、故障排查

### 问题 1：跨库查询报错 "Table doesn't exist"

**原因**：目标数据库或表不存在

**解决方案**：
```sql
-- 检查数据库是否存在
SHOW DATABASES LIKE '%rpa%';

-- 检查表是否存在
USE uibot_rpa;
SHOW TABLES;
```

### 问题 2：跨库查询报错 "Access denied"

**原因**：用户没有目标数据库的访问权限

**解决方案**：
```sql
-- 授予权限
GRANT SELECT ON uibot_rpa.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

### 问题 3：连接字符串中需要指定多个数据库

**误解**：不需要在连接字符串中指定多个数据库

**正确做法**：
- 连接字符串只指定默认数据库
- 其他数据库通过跨库查询访问（`数据库名.表名`）
- 如果是不同服务器，才需要多个连接字符串

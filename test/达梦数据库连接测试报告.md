# 达梦数据库（DM8）连接测试报告

## 📋 测试概述

本文档记录了华夏基金大屏后端项目连接达梦数据库（DM8）的测试过程和当前状态。

---

## ✅ 已完成的工作

### 1. 配置修改

#### appsettings.json 配置
```json
{
  "Db": {
    "Connection": "server=localhost;port=5236;user=SYSDBA;password=Zj20031234000;database=SYSDBA;",
    "DbType": "Dameng"
  }
}
```

#### Program.cs 配置
- 已添加动态数据库类型识别
- 支持从配置文件读取数据库类型
- FreeSql正确创建并识别为Dameng类型

### 2. NuGet包安装

| 包名 | 版本 | 状态 |
|------|------|------|
| FreeSql.All | 3.2.833 | ✅ 已安装 |
| FreeSql.Provider.Dameng | 3.2.833 | ✅ 已安装 |
| DM.DmProvider | 8.3.1.21072 | ✅ 已安装 |

### 3. 数据库服务验证

```bash
netstat -an | findstr :5236
```

**结果**: ✅ 达梦数据库服务正常运行，端口5236已监听

---

## ❌ 当前问题

### 错误信息

```
【主库】连接字符串错误，请检查。
```

### 错误堆栈

```
at FreeSql.Dameng.DamengConnectionPoolPolicy.OnGet(Object`1 obj)
at FreeSql.Internal.ObjectPool.ObjectPool`1.Get(Nullable`1 timeout)
at FreeSql.Internal.CommonProvider.AdoProvider.ExecuteScalar(...)
```

### 问题分析

错误发生在**连接池创建阶段**，而非执行SQL阶段。这表明：

1. ✅ FreeSql正确识别为Dameng类型
2. ✅ DM.DmProvider驱动已加载
3. ❌ 连接字符串格式或参数不符合DM.DmProvider的要求

---

## 🔍 尝试过的连接字符串格式

### 格式1（失败）
```
Data Source=localhost:5236;User Id=SYSDBA;PWD=Zj20031234000;
```

### 格式2（失败）
```
Server=localhost;Port=5236;User Id=SYSDBA;PWD=Zj20031234000;
```

### 格式3（失败）
```
User Id=SYSDBA;PWD=Zj20031234000;Data Source=localhost;Port=5236;
```

### 格式4（失败）
```
server=localhost;port=5236;user id=SYSDBA;password=Zj20031234000;
```

### 格式5（失败）- 当前使用
```
server=localhost;port=5236;user=SYSDBA;password=Zj20031234000;database=SYSDBA;
```

---

## 🎯 问题根源分析

### 可能的原因

#### 1. 用户权限问题
根据FreeSql文档要求："**用户名与模式名应一致**"

- 当前用户: `SYSDBA`
- 当前模式: `SYSDBA`
- 目标数据库: `HUAXIA`

**问题**: SYSDBA可能无权访问HUAXIA模式中的表

#### 2. 达梦数据库用户配置

达梦数据库的多用户架构：
- SYSDBA是管理员账户
- 实际业务数据可能在其他用户模式下
- 需要使用与模式名匹配的用户

#### 3. 表结构归属

从原MySQL代码来看，查询的表包括：
- `user_login`
- `t_dashboard_result_*`
- `uibot_rpa.tbl_user_worker`
- `uibot_rpa.tbl_worker`

这些表可能在`HUAXIA`用户模式下，而非`SYSDBA`模式。

---

## 💡 建议的解决方案

### 方案1：创建HUAXIA用户（推荐）

在达梦数据库中创建HUAXIA用户，并赋予相应权限：

```sql
-- 创建HUAXIA用户
CREATE USER HUAXIA IDENTIFIED BY "Zj20031234000";

-- 授予连接权限
GRANT CONNECT TO HUAXIA;

-- 授予资源权限
GRANT RESOURCE TO HUAXIA;

-- 授予DBA权限（如需完全访问）
GRANT DBA TO HUAXIA;

-- 将HUAXIA模式的表权限授予HUAXIA用户
GRANT ALL PRIVILEGES ON HUAXIA.* TO HUAXIA;
```

然后修改appsettings.json：
```json
{
  "Db": {
    "Connection": "server=localhost;port=5236;user=HUAXIA;password=Zj20031234000;database=HUAXIA;",
    "DbType": "Dameng"
  }
}
```

### 方案2：使用SYSDBA但指定完整表路径

修改SQL查询，使用完整的模式名：
```sql
SELECT * FROM HUAXIA.user_login
SELECT * FROM HUAXIA.t_dashboard_result_topinfo_today_runinfo
```

### 方案3：配置模式搜索路径

在连接字符串中添加模式参数：
```
server=localhost;port=5236;user=SYSDBA;password=Zj20031234000;database=HUAXIA;schema=HUAXIA;
```

---

## 📝 验证步骤

### 步骤1：使用达梦管理工具验证连接

1. 打开达梦数据库管理工具（DM Management Studio）
2. 使用以下参数连接：
   - 服务器: `localhost`
   - 端口: `5236`
   - 用户名: `SYSDBA`
   - 密码: `Zj20031234000`
3. 查看HUAXIA模式下的表：
   ```sql
   SELECT * FROM USER_TABLES WHERE USERNAME = 'HUAXIA';
   ```

### 步骤2：检查用户权限

```sql
-- 查看当前用户
SELECT USER FROM DUAL;

-- 查看所有用户
SELECT USERNAME FROM DBA_USERS;

-- 查看HUAXIA模式的表
SELECT TABLE_NAME FROM ALL_TABLES WHERE OWNER = 'HUAXIA';
```

### 步骤3：测试基本查询

```sql
-- 尝试查询user_login表
SELECT COUNT(*) FROM HUAXIA.user_login;

-- 如果失败，尝试不带模式名
SELECT COUNT(*) FROM user_login;
```

---

## 📊 当前配置总结

| 配置项 | 值 | 状态 |
|--------|-----|------|
| 数据库类型 | Dameng (DM8) | ✅ |
| 服务器地址 | localhost | ✅ |
| 端口 | 5236 | ✅ |
| 用户名 | SYSDBA | ⚠️ 需验证 |
| 密码 | Zj20031234000 | ✅ |
| 模式/数据库 | SYSDBA | ⚠️ 可能应为HUAXIA |
| FreeSql.All | 3.2.833 | ✅ |
| FreeSql.Provider.Dameng | 3.2.833 | ✅ |
| DM.DmProvider | 8.3.1.21072 | ✅ |

---

## 🎯 下一步行动

### 优先级1：验证表所有权
在达梦数据库管理工具中确认`user_login`等表属于哪个用户模式。

### 优先级2：创建匹配的用户
如果表属于HUAXIA模式，创建对应的HUAXIA用户。

### 优先级3：更新连接配置
修改appsettings.json使用正确的用户名和模式名。

### 优先级4：重新测试
运行测试API验证连接。

---

## 📚 参考资源

- [FreeSql 官方文档 - 达梦数据库](https://freesql.net/guide/)
- [Net8下使用FreeSql访问达梦v8数据库](https://blog.csdn.net/isapi/article/details/139165948)
- [达梦数据库官方文档](https://eco.dameng.com/)

---

**报告生成时间**: 2026-02-05
**测试人员**: Claude Code
**项目名称**: 华夏基金大屏后端 - laiye-customer-webapi-feature-huaxiajijin
